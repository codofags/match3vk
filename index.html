<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Match 3</title>
  <style>
    body {
      background: linear-gradient(to bottom, #ADD8E6, #87CEEB);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      overflow: hidden;
      color: white;
    }

    #gameContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #gameBoard {
      display: grid;
      grid-gap: 2px;
      border: 1px solid black;
      width: 870px;
      height: 870px;
      background-color: #77B5FE;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .cell {
      width: calc(870px / 8 - 2px);
      height: calc(870px / 8 - 2px);
      text-align: center;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s ease, background-color 0.2s ease;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border-radius: 15px;
      background-color: #6495ED;
    }

    .cell.swapping {
      transform: scale(1.2);
    }

    .cell.removing {
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    #start {
      padding: 20px 40px;
      font-size: 24px;
      cursor: pointer;
      background-color: #4682B4;
      color: white;
      border: none;
      border-radius: 10px;
      transition: background-color 0.3s ease;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
    }

    #start.hidden {
      display: none;
    }

    #start:hover {
      background-color: #5F9EA0;
    }
  </style>
</head>
<body>

  <div id="gameContainer">
    <button id="start" onclick="initialize()">Sta—ãrt</button>
    <div id="gameBoard"></div>
  </div>

  <script src="https://unpkg.com/@vkid/sdk@2.5.0/dist-sdk/umd/index.js"></script>
<script>
  const APP_ID = 8109529;
  const REDIRECT_URL = "https://codofags.github.io/match3vk/
  let userInfo = null;
  let deviceId = null;
  let tokenRefreshTimer = null;

  const VKID = window.VKIDSDK;

  function showError(message) {
    console.error(message);
  }

  function updateStatus(message) {
    console.log(message);
  }

  function hideStartButton() {
    const startButton = document.getElementById('start');
    if (startButton) {
      startButton.classList.add('hidden');
    }
  }

  function getOrCreateDeviceId() {
    let storedDeviceId = localStorage.getItem('device_id');
    if (!storedDeviceId) {
      storedDeviceId = crypto.randomUUID ? crypto.randomUUID() : 'device_' + Math.random().toString(36).substring(2, 15);
      localStorage.setItem('device_id', storedDeviceId);
    }
    return storedDeviceId;
  }

  async function initialize() {
    hideStartButton();
    
    try {
      VKID.Config.init({
        app: APP_ID,
        redirectUrl: REDIRECT_URL,
        state: generateRandomString(32),
        codeVerifier: generateRandomString(64),
        scope: 'email phone',
        responseMode: VKID.ConfigResponseMode.Callback
      });

      deviceId = getOrCreateDeviceId();
      console.log('üì± –£–Ω–∏–∫–∞–ª—å–Ω—ã–π device_id:', deviceId);

      VKID.Auth.authorize({ mode: VKID.ConfigAuthMode.InNewWindow })
        .then(handleAuthResponse)
        .catch(error => showError(`–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`));
    } catch (error) {
      showError(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
    }
  }

  function handleAuthResponse(authData) {
    if (!authData || !authData.code) {
      showError('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
      return;
    }

    const tokenData = {
      code: authData.code,
      state: authData.state,
      device_id: deviceId,
      token_datetime: new Date().toUTCString()
    };
    
    console.log("üìÖ token_datetime (RFC 5322):", tokenData.token_datetime);
    sendTokenToYourServer(tokenData);
    showGame();
  }

  async function sendTokenToYourServer(data) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    
    try {
      const response = await fetch('https://bla39d-37-45-190-41.ru.tuna.am/api/vk-token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data),
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      if (!response.ok) {
        throw new Error(`–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`);
      }
      console.log('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
      return await response.json();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', error);
      showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
    }
  }

  async function showGame() {
    try {
      await loadGameScript();
      if (typeof startGame === 'function') {
        startGame();
      } else {
        showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–≥—Ä—ã');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã:', error);
      showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É');
    }
  }

  function loadGameScript() {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'game.js';
      script.onload = resolve;
      script.onerror = reject;
      setTimeout(() => reject(new Error('–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã –∏—Å—Ç–µ–∫–ª–æ')), 5000);
      document.head.appendChild(script);
    });
  }

  function generateRandomString(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._';
    let result = '';
    for (let i = 0; i < length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }
</script>


  <script src="game.js"></script>
</body>
</html>
